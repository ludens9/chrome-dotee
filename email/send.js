// import ë¬¸ ì œê±°
// getTimeBasedMessage í•¨ìˆ˜ëŠ” messageUtil.jsì—ì„œ ì „ì—­ìœ¼ë¡œ ì‚¬ìš© ê°€ëŠ¥

function getTimeBasedMessage(totalSeconds, hasRecord = true) {
    if (!hasRecord) {
        return `Had a good rest yesterday? Let's start fresh today! ğŸ˜Š
ì–´ì œ í‘¹ ì‰¬ì—ˆìœ¼ë‹ˆ ì˜¤ëŠ˜ì€ ìƒì¾Œí•˜ê²Œ ì‹œì‘í•´ë³¼ê¹Œ? ğŸ˜Š`;
    }
    
    const hours = totalSeconds / 3600;
    
    if (hours < 4) {
        return `Yesterday was a short day! Shall we pump up the energy today? ğŸŒ±
ì–´ì œëŠ” ì§§ê²Œ ì¼í–ˆë„¤! ì˜¤ëŠ˜ì€ ì¢€ ë” í˜ë‚´ë³¼ê¹Œ? ğŸŒ±`;
    } else if (hours < 8) {
        return `Nice job wrapping up yesterday! Let's make today another good one ğŸŒŸ
ì–´ì œ í•˜ë£¨ ì˜ ë§ˆë¬´ë¦¬í–ˆì–´! ì˜¤ëŠ˜ë„ ì¢‹ì€ í•˜ë£¨ ë§Œë“¤ì–´ë³´ì ğŸŒŸ`;
    } else if (hours < 10) {
        return `You worked hard yesterday! Take it easy today, okay? âœ¨
ì–´ì œ ì—´ì‹¬íˆ í–ˆìœ¼ë‹ˆ ì˜¤ëŠ˜ì€ ì ë‹¹íˆ ì‰¬ì–´ê°€ë©´ì„œ í•˜ì âœ¨`;
    } else {
        return `Wow, that was a long day yesterday! Remember to take breaks today ğŸ’ª
ì–´ì œ ì§„ì§œ ë§ì´ ì¼í–ˆë‹¤! ì˜¤ëŠ˜ì€ í‹ˆí‹ˆì´ ì‰¬ë©´ì„œ í•˜ì ğŸ’ª`;
    }
}

async function calculateWeeklyTotal(baseDate) {
    try {
        const { workRecords = {} } = await chrome.storage.local.get('workRecords');
        const weekStart = new Date(baseDate);
        weekStart.setDate(weekStart.getDate() - weekStart.getDay());
        weekStart.setHours(0, 0, 0, 0);
        
        const weekStartStr = weekStart.toISOString().split('T')[0];
        const baseDateStr = baseDate.toISOString().split('T')[0];
        
        let weekTotal = 0;
        Object.entries(workRecords)
            .filter(([date]) => date >= weekStartStr && date <= baseDateStr)
            .forEach(([_, dayRecords]) => {
                weekTotal += dayRecords.reduce((sum, record) => sum + (record.duration || 0), 0);
            });
        
        return weekTotal;
    } catch (error) {
        console.error('ì£¼ê°„ í•©ê³„ ê³„ì‚° ì‹¤íŒ¨:', error);
        return 0;
    }
}

async function calculateMonthlyTotal(baseDate) {
    try {
        const { workRecords = {} } = await chrome.storage.local.get('workRecords');
        const monthStart = new Date(baseDate.getFullYear(), baseDate.getMonth(), 1);
        monthStart.setHours(0, 0, 0, 0);
        
        const monthStartStr = monthStart.toISOString().split('T')[0];
        const baseDateStr = baseDate.toISOString().split('T')[0];
        
        let monthTotal = 0;
        Object.entries(workRecords)
            .filter(([date]) => date >= monthStartStr && date <= baseDateStr)
            .forEach(([_, dayRecords]) => {
                monthTotal += dayRecords.reduce((sum, record) => sum + (record.duration || 0), 0);
            });
        
        return monthTotal;
    } catch (error) {
        console.error('ì›”ê°„ í•©ê³„ ê³„ì‚° ì‹¤íŒ¨:', error);
        return 0;
    }
}

document.addEventListener('DOMContentLoaded', async () => {
    try {
        const emailService = new EmailService();
        const settings = await chrome.storage.local.get(['email', 'reportTime']);
        if (!settings.email) {
            throw new Error('ì´ë©”ì¼ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.');
        }

        // ì–´ì œ ë‚ ì§œ ê³„ì‚°
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        
        // ê·¼ë¬´ ê¸°ë¡ ì¡°íšŒ
        const { workRecords = {} } = await chrome.storage.local.get('workRecords');
        const yesterdayStr = yesterday.toISOString().split('T')[0];
        const yesterdayRecords = workRecords[yesterdayStr] || [];

        // ì²« ì¶œê·¼, ë§ˆì§€ë§‰ í‡´ê·¼ ì‹œê°„ ê³„ì‚°
        let startTime = 'ê¸°ë¡ ì—†ìŒ';
        let endTime = 'ê¸°ë¡ ì—†ìŒ';
        let totalSeconds = 0;

        if (yesterdayRecords.length > 0) {
            startTime = new Date(yesterdayRecords[0].startTime).toLocaleTimeString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            endTime = new Date(yesterdayRecords[yesterdayRecords.length - 1].endTime).toLocaleTimeString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            totalSeconds = yesterdayRecords.reduce((total, record) => total + record.duration, 0);
        }

        // ì£¼ê°„/ì›”ê°„ í†µê³„ ê³„ì‚°
        const weekTotal = await calculateWeeklyTotal(yesterday);
        const lastWeekTotal = await calculateWeeklyTotal(new Date(yesterday.getTime() - 7 * 24 * 60 * 60 * 1000));
        const monthTotal = await calculateMonthlyTotal(yesterday);
        const lastMonthTotal = await calculateMonthlyTotal(new Date(yesterday.getFullYear(), yesterday.getMonth() - 1, yesterday.getDate()));

        // ìš”ì¼ ê³„ì‚°
        const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        const weekday = weekdays[yesterday.getDay()];

        document.getElementById('status').textContent = 'ì´ë©”ì¼ ë°œì†¡ ì¤‘...';

        // ë©”ì‹œì§€ ìƒì„±
        const timeBasedMessage = yesterdayRecords.length === 0 
            ? getTimeBasedMessage(0, false)  // ê·¼ë¬´ ê¸°ë¡ì´ ì—†ëŠ” ê²½ìš°
            : getTimeBasedMessage(totalSeconds, true);  // ê·¼ë¬´ ê¸°ë¡ì´ ìˆëŠ” ê²½ìš°

        // ì´ë©”ì¼ ë°œì†¡
        await emailService.sendEmail({
            to_email: settings.email,
            date: `${yesterday.getMonth() + 1}ì›” ${yesterday.getDate()}ì¼`,
            weekday: weekday,
            start_time: startTime,
            end_time: endTime,
            total_hours: (totalSeconds / 3600).toFixed(1),
            week_hours: (weekTotal / 3600).toFixed(1),
            last_week_hours: (lastWeekTotal / 3600).toFixed(1),
            month_hours: (monthTotal / 3600).toFixed(1),
            last_month_hours: (lastMonthTotal / 3600).toFixed(1),
            message: timeBasedMessage,
            has_notice: yesterdayRecords.length === 0,
            notices: [],
            week_status: `${weekday}ì¼ ê¸°ì¤€`,
        });

        document.getElementById('status').textContent = 'ì´ë©”ì¼ ë°œì†¡ ì™„ë£Œ!';
        setTimeout(() => window.close(), 3000);

    } catch (error) {
        console.error('ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨:', error);
        document.getElementById('status').textContent = 'ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨: ' + error.message;
    }
}); 